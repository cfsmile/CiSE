#+Title: Active Documents with Org-mode
#+Author:
#+LATEX_HEADER: \usepackage{attrib}
#+Options: ^:nil toc:nil
#+Startup: hideblocks

\begin{abstract}
  Reproducibility is essential to peer reviewed research, however,
  refereed scientific publications often lack the information required
  to reproduce the research and analysis described in the work.
  \begin{quote}
    An article about computational science in a scientific publication
    is not the scholarship itself, it is merely advertising of the
    scholarship.  The actual scholarship is the complete software
    development environment and complete set of instructions which
    generated the figures.
    \attrib{David L. Donoho}
  \end{quote}
  Org-mode is a simple plain text markup language for hierarchical
  documents allowing intermingled data, code and prose.  An entire
  research project including; initial note taking, planning and task
  management, experimentation, analysis and publication, may take
  place within a single Org-mode document.  This article introduces
  Org-mode including a overview of syntax, a working example of
  reproducible research, and motivation for the features which make
  Org-mode a particularly useful tool for the scientific researcher.
\end{abstract}

* Introduction

Org-mode was initially developed as a simple outlining tool intended
for note taking and brainstorming.  It was later augmented with task
management tools---enabling notes to be transformed into tasks with
deadlines and priorities---and with syntax for the inclusion of
tables, data blocks, and active code blocks.  Org-mode may still be
used as a simple plain-text note taking system, however increasingly
sophisticated features may be gradually introduced as the comfort of
the user permits.

Reproducible Research (RR) is the practice of publishing scientific
results along with the software environment and data required for
reproduction of all computational analysis presented in the
publication.  Org-mode supports RR through syntax for including
in-line data and code, mechanisms for evaluating embedded code, and
publishing functionality which may be used to automate the
computational analysis and generation of figures included in a
publication.  This introduction will focus on these aspects of
Org-mode which enable the practice of RR---for information on other
aspects of Org-mode see the online manual [fn:2] and the community
wiki [fn:3]---this article is available as an Org-mode document with
which the examples presented below may be interactively executed [fn:4].

* Syntax
** Outlines
Org-mode documents are organized as hierarchical outline.  As such
they may be folded and expanded so that at any given time most of the
content of the document is hidden from view.  In this way even very
large documents may be comfortably navigated in a manner similar to
that of a file system.  Headlines are indicated by leading =*='s as
shown below in the folded view of this article from within Org-mode.

#+source: folded-org
#+headers: :exports results
#+begin_src sh :var this=(buffer-file-name) :results output
  cat $this|grep "^\*"|sed 's/$/.../g'
#+end_src

#+label: fig:folded-org
#+results: folded-org

The =...='s at the end of each line indicate that the content of the
heading is hidden from view.  Notice that the heading beginning with
the keyword =COMMENT= is not included in the exported document.
Org-mode uses many such keywords for associating information with
headlines.

** Code and Data
Using a simple `block' syntax both code and data may be embedded in
Org-mode documents.  The following demonstrate both a data block and a
code block as seen form within an Org-mode document.

#+begin_src org :exports code
  ,First a data block.
  ,#+begin_example
  ,  raw textual data
  ,#+end_example
  
  ,Second a code block.
  ,#+begin_src sh
  ,  echo "shell script code"
  ,#+end_src
#+end_src

Such blocks may be named, allowing their contents to be referenced
form elsewhere in the Org-mode file.  The following augments the
previous example with references, allowing the shell script to
reference the contents of the data block.

#+begin_src org :exports code
  ,First a data block.
  ,#+results: raw-data
  ,#+begin_example
  ,  raw textual data
  ,#+end_example
  
  ,Second a code block.
  ,#+begin_src sh :var text=raw-data
  ,  echo $text|wc
  ,#+end_src
  
  ,#+results:
  ,: 1       3      17
#+end_src

Such cross references between the code and data elements of an
Org-mode file turn Org-mode into a powerful multi-lingual programming
environment, in which data and code expressed in many different
programming languages may interact.

* Evaluation
Code and data references make possible strings of /chained
evaluation/.  Figure \ref{fig:chained-evaluation} shows the series of
actions which result when the =analyze= code block is evaluated
interactively or as part of export to a publishable.

#+label: fig:chained-evaluation
#+Caption: Active Org-mode Document
#+attr_latex: width=\textwidth
[[file:chained-evaluation.pdf]]

1. The =analyze= code block is evaluated.  The =:var data=data= header
   argument causes the =data= Org-mode to evaluate the =data= reference.

2. To resolve this reference the =data= code block is located in the
   Org-mode file and is evaluated.

3. The =:var raw=raw= header argument causes Org-mode to resolve the
   =raw= reference.

4. The =raw= code block is evaluated, the =:var url=http://data.org=
   header argument is evaluated as a literate value which is assigned
   to the =url= variable and passed to the shell script.
   
   The shell script then downloads data from the external url, and
   returns this data as the result to Org-mode.

5. The results of the shell script are assigned to the =raw= variable
   which is passed to the Python code in the body of the =data= code
   block.

6. This code is passed to an external Python interpreter which
   evaluates the Python code and returns its result to Org-mode.

7. The results of the =data= code block are then assigned to the
   =data= variable and passed to the R code in the body of the
   =analyze= code block.

8. This code is then passed to an external R interpreter which
   evaluates the R code and generates the =fig.pdf= figure.

9. A reference to this figure is then passed from the =analyze= code
   block back to Org-mode which inserts a link to this figure into the
   body of the Org-mode document.  On export this link will embed the
   linked figure into the exported document.

* Example Application
** Download External Data
This example will show correlation of home team offensive statistics
with attendance for the src_sh[:var season=season]{echo $season}
season.

#+begin_src org
  ,#+results: season
  ,: 2010
#+end_src

#+source: season
#+begin_src emacs-lisp :exports none
  2010
#+end_src

This first code block translates the numerical season shown above into
the url for =retrosheet.org= [fn:1].

#+begin_src org
  ,#+source: url
  ,#+begin_src sh :var season=season :exports none
  ,  echo "http://www.retrosheet.org/gamelogs/gl$season.zip"
  ,#+end_src
#+end_src

#+source: url
#+begin_src sh :var season=season :exports none
  echo "http://www.retrosheet.org/gamelogs/gl$season.zip"
#+end_src

The statistics are downloaded and saved to a local text file.  The
=:cache yes= header argument ensures that the code block is only run
once and the data is not re-downloaded every time the code block is
evaluated.

#+begin_src org
  ,#+source: raw-data
  ,#+headers: :exports none
  ,#+begin_src sh :cache yes :var url=url :file 2010.csv
    wget $url && \
        unzip -p gl2010.zip > 2010.csv && \
        rm gl2010.zip
  ,#+end_src
#+end_src

#+source: raw-data
#+headers: :exports none
#+begin_src sh :cache yes :var url=url :file 2010.csv
  wget $url && \
      unzip -p gl2010.zip > 2010.csv && \
      rm gl2010.zip
#+end_src

The next code block returns the names of the offensive statistics
which we will be testing for correlation.

#+begin_src org
  ,#+source: stat-headers
  ,#+headers: :exports none
  ,#+begin_src python :results list :cache yes :return fields
    import urllib2
    url = 'http://www.retrosheet.org/gamelogs/glfields.txt'
    fp = urllib2.urlopen(url)
    fields = []
    for line in fp:
        if line.find('Visiting team offensive statistics') != -1:
            line = fp.readline()
            while line.find('Visiting team pitching statistics') == -1:
                if line[13] != ' ':
                    fields.append(line.strip().split('.')[0].split('(')[0])
                line = fp.readline()
  ,#+end_src
#+end_src

#+source: stat-headers
#+headers: :exports none
#+begin_src python :results list :cache yes :return fields
  import urllib2
  url = 'http://www.retrosheet.org/gamelogs/glfields.txt'
  fp = urllib2.urlopen(url)
  fields = []
  for line in fp:
      if line.find('Visiting team offensive statistics') != -1:
          line = fp.readline()
          while line.find('Visiting team pitching statistics') == -1:
              if line[13] != ' ':
                  fields.append(line.strip().split('.')[0].split('(')[0])
              line = fp.readline()
#+end_src

** Parsing
The next two code blocks collect the offensive statistics, and the
attendance, from the raw data file.

#+begin_src org
  ,#+source: offensive-stats
  ,#+headers: :exports none
  ,#+begin_src sh :var file=raw-data
    awk '{for (x=50; x<=66; x++) {  printf "%s ", $x } printf "\n" }' FS="," \
        < $file
  ,#+end_src
#+end_src
#+begin_src org
  ,#+source: attendance
  ,#+headers: :exports none
  ,#+begin_src sh :var file=raw-data
    awk '{ print $18 }' FS="," < $file
  ,#+end_src
#+end_src

#+source: offensive-stats
#+headers: :exports none
#+begin_src sh :var file=raw-data
  awk '{for (x=50; x<=66; x++) {  printf "%s ", $x } printf "\n" }' FS="," \
      < $file
#+end_src

#+source: attendance
#+headers: :exports none
#+begin_src sh :var file=raw-data
  awk '{ print $18 }' FS="," < $file
#+end_src

** Analysis
This code block uses the =R= statistical programming language to
calculate correlations.

#+begin_src org
  ,#+source: analysis
  ,#+headers: :var headers=stat-headers :var stats=offensive-stats
  ,#+begin_src R :var attendance=attendance :cache yes :exports none
    # apply the headers to the list
    colnames(stats) <- headers
    
    ## The following lines are required because parsing bugs are causing
    ## corrupt data in these two rows.
    badrows <- c(141, 674)
    stats <- stats[-badrows,]
    attendance <- attendance[-badrows,]
    attendance <- as.integer(attendance)
    
    # perform a simple correlation of each column with the attendance
    corrln <- cor(stats, attendance)
    
    # return the name of the most correlated column
    rownames(corrln)[which.max(corrln)]
  ,#+end_src
#+end_src

#+source: analysis
#+headers: :var headers=stat-headers :var stats=offensive-stats
#+begin_src R :var attendance=attendance :cache yes :exports none
  # apply the headers to the list
  colnames(stats) <- headers
  
  ## The following lines are required because parsing bugs are causing
  ## corrupt data in these two rows.
  badrows <- c(141, 674)
  stats <- stats[-badrows,]
  attendance <- attendance[-badrows,]
  attendance <- as.integer(attendance)
  
  # perform a simple correlation of each column with the attendance
  corrln <- cor(stats, attendance)
  
  # return the name of the most correlated column
  rownames(corrln)[which.max(corrln)]
#+end_src

The most correlated column, namely src_sh[:var stat=analysis]{echo $stat}, can
be mentioned in the text using an inline code block.  The Org-mode
syntax for an inline block can be seen below.

#+begin_src org
  The most correlated column (src_sh[:var stat=analysis]{echo $stat})
  can be mentioned in the text using an inline code block.  The Org-mode
  syntax for an inline block can be seen below.
#+end_src

** Display
Using gnuplot we can plot the number of forced walks and the
attendance for the five games with the most forced walks (see Figure
\ref{fig:top-5}).

#+begin_src org
  ,#+source: top-8
  ,#+begin_src sh :var data=raw-data :cache yes :exports none
    cat $data|awk '{print $60,$18,$7"-"$4}' FS=","|sed 's/"//g'|sort -rn |head -5
  ,#+end_src
#+end_src
#+begin_src org
  ,#+source: figure
  ,#+begin_src gnuplot :var data=top-8 :file plot.png :cache yes :exports results
    set yrange [0:6]
    set y2range [0:50000]
    set style data histogram
    set style histogram clustered
    set xtic rotate by -45 scale 0
    plot data using 1:xtic(3) title 'forced walks', \
         data using 2:xtic(3) axes x1y2 title 'attendance'
  ,#+end_src
#+end_src

#+source: top-8
#+begin_src sh :var data=raw-data :cache yes :exports none
  cat $data|awk '{print $60,$18,$7"-"$4}' FS=","|sed 's/"//g'|sort -rn |head -5
#+end_src

#+source: figure
#+begin_src gnuplot :var data=top-8 :file plot.png :cache yes :exports results
  set yrange [0:6]
  set y2range [0:50000]
  set y2tics border
  set ylabel 'forced walks'
  set y2label 'attendance'
  set style data histogram
  set style histogram clustered
  set xtic rotate by -45 scale 0
  plot data using 1:xtic(3) title 'forced walks', \
       data using 2:xtic(3) axes x1y2 title 'attendance'
#+end_src

#+label: fig:top-5
#+attr_latex: width=0.8\textwidth
#+Caption: Top 5 games by forced walks, with forced walks and attendance shown.
#+results: figure
[[file:plot.png]]

Co-mingling code and prose as demonstrated in this example benefits
the author by collecting all relevant information into a single place,
and benefits the reader through ensuring not only easy reproduction of
the calculations performed in the work, but also easy extension, for
example the reader of this article may easily re-run all analysis over
other baseball seasons to test the generality of the result.

* Conclusion
The following features make Org-mode an excellent tool enabling
reproducible research. (will need to condense this drastically).

- Natural :: Org-mode documents can be used simply as plain text
     notes, as a hierarchical outlining system, or as an entire
     laboratory.  These various levels of sophistication enable quick
     adoption followed by gradual learning and mastery.
- Navigation of Large Projects :: The hierarchical folding of Org-mode
     documents enables users to comfortably read and edit even very
     large files by hiding much of the file from plain site.
- Familiar editing environment :: Org-mode leverages the sophisticated
     editing modes available in Emacs for both natural and
     computational languages.
- Reproducibility :: Org-mode makes reproduction the analysis embedded
     in a document trivial for both the original author and for
     readers.
- Portable :: Org-mode files are plain text ensuring that they can
     easily be used on any machine.
- Provenance :: Given that Org-mode files are plain text, they
     integrate easily into version control systems, allowing for
     revision tracking and collaboration.
- Consistency :: A single Org-mode document can be used for every
     stage of a research project from brain-storming, through initial
     development, and to publication.  This greatly reduces the burden
     on the author of tracking resources, and increases the chance
     that all information required for reproduction of the work will
     be maintained.
- Open Source :: Org-mode is open source software.  Its inner workings
     are publicly visible, and its copyright is owned by the Free
     Software Foundation FSF.  This ensures that Org-mode and any work
     deriving from Org-mode will always be fully open to public
     scrutiny and modification.  These are essential qualities for
     software tools used for reproducible research.  The transparency
     required for computational results to be accepted by the
     scientific community can only be achieved when the workings of
     each tool in the scientist's tool chain is open to inspection and
     verification.
- Active community :: The Org-mode community provides ready support to
     both novice users with basic questions and to developers seeking
     to extend Org-mode.  The development of Org-mode would not have
     been possible without the attention and effort of this community.
- General and extensible :: A main design goal of Org-mode's support
     for working with source code was generality.  As a result, it
     displays no reproducible research or literate programming bias,
     supports arbitrary programming languages, and exports to a wide
     variety of file types, including ASCII, \LaTeX{}, HTML, and
     DocBook.  Researchers and software developers who adopt Org-mode
     can be confident that it will be able to adapt to new languages
     or modes of development.

* COMMENT How to Export this Document
Evaluate the following emacs-lisp code block to configure Org-mode for
export of this paper.
#+begin_src emacs-lisp :results silent
  (setf org-babel-default-header-args:org '((:exports . "code")))
#+end_src

* Footnotes
[fn:1] The information used here was obtained free of charge from and
       is copyrighted by Retrosheet.  Interested parties may contact
       Retrosheet at "www.retrosheet.org".
[fn:2] http://orgmode.org/manual/
[fn:3] http://orgmode.org/worg/
[fn:4] https://github.com/eschulte/CiSE/raw/master/org-mode-active-doc.org
